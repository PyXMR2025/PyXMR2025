name: Sync Blog Posts

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'README.md'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'none'
          
      - name: Install dependencies
        run: python -m pip install --upgrade pip feedparser
          
      - name: Fetch and update blog posts
        run: |
          python -c "
import feedparser
import re

rss_url = 'https://jackie.openenet.cn/atom.xml'
readme_path = 'README.md'
max_posts = 5

feed = feedparser.parse(rss_url)
posts = []

for entry in feed.entries[:max_posts]:
    title = entry.get('title', 'No Title').strip()
    link = entry.get('link', '#').strip()
    published = entry.get('published', '')
    
    if published and len(published) >= 10:
        date_str = published[:10]
    else:
        date_str = ''
    
    posts.append({'title': title, 'link': link, 'date': date_str})

if posts:
    post_lines = []
    for post in posts:
        prefix = 'ğŸ“… ' + post['date'] + ' ' if post['date'] else ''
        post_lines.append('- ' + prefix + '[' + post['title'] + '](' + post['link'] + ')')
    posts_text = '\n'.join(post_lines)
    new_section = '<!-- BLOG-POST-LIST:START -->\n' + posts_text + '\n<!-- BLOG-POST-LIST:END -->'
else:
    new_section = '<!-- BLOG-POST-LIST:START -->\n- âŒ æ— æ³•è·å–åšå®¢æ–‡ç« \n<!-- BLOG-POST-LIST:END -->'

with open(readme_path, 'r', encoding='utf-8') as f:
    content = f.read()

pattern = r'<!-- BLOG-POST-LIST:START -->.*?<!-- BLOG-POST-LIST:END -->'
new_content = re.sub(pattern, new_section, content, flags=re.DOTALL)

with open(readme_path, 'w', encoding='utf-8') as f:
    f.write(new_content)

print('Successfully updated', len(posts), 'blog posts')
"
          
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add README.md
          git diff --quiet || git commit -m "ğŸ”„ Sync blog posts - $(date '+%Y-%m-%d %H:%M')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
