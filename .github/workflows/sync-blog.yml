name: Sync Blog Posts

on:
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤© UTC 8:00 (åŒ—äº¬æ—¶é—´ 16:00)
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'README.md'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set timezone to Beijing
        run: sudo timedatectl set-timezone Asia/Shanghai

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install feedparser requests

      - name: Fetch and update blog posts
        run: |
          python << EOF
          import feedparser
          import re
          import requests
          from datetime import datetime, timezone, timedelta

          # é…ç½®é¡¹
          RSS_URL = "https://jackie.openenet.cn/atom.xml"
          README_PATH = "README.md"
          MAX_POSTS = 5
          CST = timezone(timedelta(hours=8))

          def fetch_rss_feed(url):
              try:
                  response = requests.get(url, timeout=10)
                  response.raise_for_status()
                  return feedparser.parse(response.content)
              except requests.exceptions.RequestException as e:
                  print(f"âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}")
                  return None

          try:
              feed = fetch_rss_feed(RSS_URL)
              posts = []

              if not feed or feed.get('bozo', 1) == 1:
                  raise Exception("RSSè§£æå¤±è´¥æˆ–è¿”å›ç©ºå†…å®¹")

              for entry in feed.entries[:MAX_POSTS]:
                  title = entry.get('title', 'No Title').strip() or 'No Title'
                  link = entry.get('link', '#').strip() or '#'
                  published = entry.get('published', '')
                  date_str = ''

                  if published:
                      try:
                          if len(published) >= 10:
                              date_obj = datetime.strptime(published[:10], '%Y-%m-%d')
                              date_str = date_obj.strftime('%Y-%m-%d')
                          else:
                              date_str = published
                      except Exception as e:
                          print(f"âš ï¸ æ—¶é—´è§£æå¤±è´¥: {e}ï¼Œä½¿ç”¨åŸå§‹å€¼: {published[:20]}")
                          date_str = published[:20]

                  posts.append({'title': title, 'link': link, 'date': date_str})

              # ç®€åŒ–å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œé¿å…YAMLè§£ææ­§ä¹‰
              if posts:
                  post_lines = []
                  for post in posts:
                      date_prefix = f"ğŸ“… {post['date']} " if post['date'] else ""
                      post_lines.append(f"- {date_prefix}[{post['title']}]({post['link']})")
                  posts_text = "\n".join(post_lines)
                  new_section = "<!-- BLOG-POST-LIST:START -->\n" + posts_text + "\n<!-- BLOG-POST-LIST:END -->"
              else:
                  new_section = "<!-- BLOG-POST-LIST:START -->\n- âŒ æ— æ³•è·å–åšå®¢æ–‡ç«  / Unable to fetch blog posts\n<!-- BLOG-POST-LIST:END -->"

              # è¯»å†™READMEæ–‡ä»¶
              try:
                  with open(README_PATH, 'r', encoding='utf-8') as f:
                      content = f.read()
              except FileNotFoundError:
                  raise Exception(f"âŒ æ‰¾ä¸åˆ°æ–‡ä»¶: {README_PATH}")
              except PermissionError:
                  raise Exception(f"âŒ æ— è¯»å–æƒé™: {README_PATH}")

              # æ›¿æ¢å†…å®¹ï¼ˆå•è¡Œå†™æ³•ï¼Œé¿å…YAMLæ¢è¡Œé”™è¯¯ï¼‰
              pattern = r'<!-- BLOG-POST-LIST:START -->.*?<!-- BLOG-POST-LIST:END -->'
              new_content = re.sub(pattern, new_section, content, flags=re.DOTALL)

              with open(README_PATH, 'w', encoding='utf-8') as f:
                  f.write(new_content)

              print(f"âœ… æˆåŠŸæ›´æ–° {len(posts)} ç¯‡åšå®¢æ–‡ç« ")

          except Exception as e:
              print(f"âŒ æ‰§è¡Œå‡ºé”™: {str(e)}")
              # é”™è¯¯æç¤ºï¼ˆå•è¡Œæ‹¼æ¥ï¼Œæ— åµŒå¥—æ¢è¡Œï¼‰
              error_section = "<!-- BLOG-POST-LIST:START -->\n- âŒ è·å–åšå®¢æ–‡ç« å¤±è´¥ / Failed to fetch blog posts\n<!-- BLOG-POST-LIST:END -->"
              try:
                  with open(README_PATH, 'r', encoding='utf-8') as f:
                      content = f.read()
                  new_content = re.sub(pattern, error_section, content, flags=re.DOTALL)
                  with open(README_PATH, 'w', encoding='utf-8') as f:
                      f.write(new_content)
              except:
                  pass
              raise
          EOF

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          if git diff --cached --quiet; then
              echo "â„¹ï¸ æ— ä¿®æ”¹ï¼Œè·³è¿‡æäº¤"
          else
              git commit -m "ğŸ”„ Sync blog posts - $(date '+%Y-%m-%d %H:%M:%S') (CST)"
              git push || (sleep 5 && git push) || (sleep 10 && git push)
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: success()