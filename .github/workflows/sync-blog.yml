name: Sync Blog Posts

on:
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤© UTC 8:00 (åŒ—äº¬æ—¶é—´ 16:00)
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'README.md'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11']
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set timezone to Beijing
        run: sudo timedatectl set-timezone Asia/Shanghai

      - name: Checkout blog repository
        uses: actions/checkout@v4
        with:
          repository: pyxmr2025/blog
          path: blog  # å…‹éš†åˆ°å½“å‰å·¥ä½œç›®å½•çš„blogå­æ–‡ä»¶å¤¹
          token: ${{ secrets.BLOG_REPO_PAT }}  # éœ€è¦ä½ åˆ›å»ºPATå¹¶æ·»åŠ ä¸ºä»“åº“ç§˜é’¥
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install feedparser requests

      - name: Fetch and update blog posts
        run: |
          python << EOF
          import feedparser
          import re
          import requests
          from datetime import datetime, timezone, timedelta
          import os

          # é…ç½®é¡¹
          RSS_URL = "https://jackie.openenet.cn/atom.xml"
          # è¦æ›´æ–°çš„æ–‡ä»¶åˆ—è¡¨
          TARGET_FILES = [
              "README.md",  # å½“å‰ä»“åº“çš„README
              "blog/source/about/index.md"  # blogä»“åº“çš„index.md
          ]
          MAX_POSTS = 5
          CST = timezone(timedelta(hours=8))

          def fetch_rss_feed(url):
              try:
                  response = requests.get(url, timeout=10)
                  response.raise_for_status()
                  return feedparser.parse(response.content)
              except requests.exceptions.RequestException as e:
                  print(f"âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}")
                  return None

          def update_file_content(file_path, new_section):
              """é€šç”¨çš„æ–‡ä»¶æ›´æ–°å‡½æ•°"""
              if not os.path.exists(file_path):
                  print(f"âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨: {file_path}")
                  return False
              
              try:
                  with open(file_path, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  # æ›¿æ¢æŒ‡å®šåŒºåŸŸçš„å†…å®¹
                  pattern = r'<!-- BLOG-POST-LIST:START -->.*?<!-- BLOG-POST-LIST:END -->'
                  new_content = re.sub(pattern, new_section, content, flags=re.DOTALL)
                  
                  with open(file_path, 'w', encoding='utf-8') as f:
                      f.write(new_content)
                  
                  print(f"âœ… æˆåŠŸæ›´æ–°æ–‡ä»¶: {file_path}")
                  return True
              except Exception as e:
                  print(f"âŒ æ›´æ–°æ–‡ä»¶å¤±è´¥ {file_path}: {e}")
                  return False

          try:
              feed = fetch_rss_feed(RSS_URL)
              posts = []

              if not feed or feed.get('bozo', 1) == 1:
                  raise Exception("RSSè§£æå¤±è´¥æˆ–è¿”å›ç©ºå†…å®¹")

              for entry in feed.entries[:MAX_POSTS]:
                  title = entry.get('title', 'No Title').strip() or 'No Title'
                  link = entry.get('link', '#').strip() or '#'
                  published = entry.get('published', '')
                  date_str = ''

                  if published:
                      try:
                          if len(published) >= 10:
                              date_obj = datetime.strptime(published[:10], '%Y-%m-%d')
                              date_str = date_obj.strftime('%Y-%m-%d')
                          else:
                              date_str = published
                      except Exception as e:
                          print(f"âš ï¸ æ—¶é—´è§£æå¤±è´¥: {e}ï¼Œä½¿ç”¨åŸå§‹å€¼: {published[:20]}")
                          date_str = published[:20]

                  posts.append({'title': title, 'link': link, 'date': date_str})

              # ç”Ÿæˆæ–°çš„å†…å®¹åŒºåŸŸ
              if posts:
                  post_lines = []
                  for post in posts:
                      date_prefix = f"ğŸ“… {post['date']} " if post['date'] else ""
                      post_lines.append(f"- {date_prefix}[{post['title']}]({post['link']})")
                  posts_text = "\n".join(post_lines)
                  new_section = "<!-- BLOG-POST-LIST:START -->\n" + posts_text + "\n<!-- BLOG-POST-LIST:END -->"
              else:
                  new_section = "<!-- BLOG-POST-LIST:START -->\n- âŒ æ— æ³•è·å–åšå®¢æ–‡ç«  / Unable to fetch blog posts\n<!-- BLOG-POST-LIST:END -->"

              # æ‰¹é‡æ›´æ–°æ‰€æœ‰ç›®æ ‡æ–‡ä»¶
              for file_path in TARGET_FILES:
                  update_file_content(file_path, new_section)

              print(f"âœ… æˆåŠŸè·å–å¹¶å¤„ç† {len(posts)} ç¯‡åšå®¢æ–‡ç« ")

          except Exception as e:
              print(f"âŒ æ‰§è¡Œå‡ºé”™: {str(e)}")
              # ç”Ÿæˆé”™è¯¯æç¤ºå†…å®¹
              error_section = "<!-- BLOG-POST-LIST:START -->\n- âŒ è·å–åšå®¢æ–‡ç« å¤±è´¥ / Failed to fetch blog posts\n<!-- BLOG-POST-LIST:END -->"
              # ç»™æ‰€æœ‰ç›®æ ‡æ–‡ä»¶å†™å…¥é”™è¯¯æç¤º
              for file_path in TARGET_FILES:
                  update_file_content(file_path, error_section)
              raise
          EOF

      - name: Commit and push current repo changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          if git diff --cached --quiet; then
              echo "â„¹ï¸ å½“å‰ä»“åº“æ— ä¿®æ”¹ï¼Œè·³è¿‡æäº¤"
          else
              git commit -m "ğŸ”„ Sync blog posts - $(date '+%Y-%m-%d %H:%M:%S') (CST)"
              git push || (sleep 5 && git push) || (sleep 10 && git push)
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: success()

      - name: Create PR for blog repo changes
        run: |
          # è¿›å…¥blogä»“åº“ç›®å½•
          cd blog
          
          # é…ç½®gitç”¨æˆ·ä¿¡æ¯
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆé¿å…åˆ†æ”¯å†²çªï¼‰
          git pull origin main
          
          # åˆ›å»ºæ–°åˆ†æ”¯ï¼ˆä½¿ç”¨æ—¶é—´æˆ³ç¡®ä¿åˆ†æ”¯åå”¯ä¸€ï¼‰
          BRANCH_NAME="sync-blog-posts-$(date +%Y%m%d%H%M%S)"
          git checkout -b $BRANCH_NAME
          
          # æ·»åŠ ä¿®æ”¹çš„æ–‡ä»¶
          git add source/about/index.md
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹
          if git diff --cached --quiet; then
              echo "â„¹ï¸ Blogä»“åº“æ— ä¿®æ”¹ï¼Œè·³è¿‡PRåˆ›å»º"
              git checkout main
              git branch -D $BRANCH_NAME
              exit 0
          fi
          
          # æäº¤ä¿®æ”¹
          git commit -m "ğŸ”„ Sync blog posts - $(date '+%Y-%m-%d %H:%M:%S') (CST)"
          
          # æ¨é€æ–°åˆ†æ”¯åˆ°è¿œç¨‹
          git push origin $BRANCH_NAME || (sleep 5 && git push origin $BRANCH_NAME) || (sleep 10 && git push origin $BRANCH_NAME)
          
          # å®‰è£…GitHub CLIï¼ˆç”¨äºåˆ›å»ºPRï¼‰
          type -p gh >/dev/null || (sudo apt update && sudo apt install gh -y)
          
          # é…ç½®ghä½¿ç”¨PATè®¤è¯
          echo "${{ secrets.BLOG_REPO_PAT }}" | gh auth login --with-token
          
          # åˆ›å»ºPull Request
          gh pr create \
            --base main \
            --head $BRANCH_NAME \
            --title "ğŸ”„ Sync blog posts - $(date '+%Y-%m-%d %H:%M:%S') (CST)" \
            --body "Automatically synced blog posts from RSS feed.
          
          - Updated blog post list in source/about/index.md
          - Sync time: $(date '+%Y-%m-%d %H:%M:%S') (CST)
          
          This PR is created automatically by GitHub Actions."
          
          echo "âœ… PR created successfully for blog repository"
        env:
          GITHUB_TOKEN: ${{ secrets.BLOG_REPO_PAT }}
        if: success()
