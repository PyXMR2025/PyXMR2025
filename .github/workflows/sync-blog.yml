name: Sync Blog Posts

on:
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤© UTC 8:00 (åŒ—äº¬æ—¶é—´ 16:00)
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'README.md'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ä¿®å¤æµ…å…‹éš†é—®é¢˜ï¼Œæ‹‰å–å®Œæ•´å†å²
          persist-credentials: true  # ä¿ç•™å‡­è¯ï¼Œç¡®ä¿pushå¯ç”¨

      - name: Set timezone to Beijing
        run: sudo timedatectl set-timezone Asia/Shanghai

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'  # ç¼“å­˜pipä¾èµ–ï¼ŒåŠ é€Ÿæ„å»º

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install feedparser requests  # å¢åŠ requestsç”¨äºç½‘ç»œæ£€æµ‹

      - name: Fetch and update blog posts
        run: |
          python << 'PYEOF'
          import feedparser
          import re
          import requests
          from datetime import datetime, timezone, timedelta
          
          # é…ç½®é¡¹
          RSS_URL = "https://jackie.openenet.cn/atom.xml"
          README_PATH = "README.md"
          MAX_POSTS = 5
          # è®¾ç½®åŒ—äº¬æ—¶é—´æ—¶åŒº
          CST = timezone(timedelta(hours=8))
          
          def fetch_rss_feed(url):
              """è·å–RSS feedï¼Œå¢åŠ è¶…æ—¶å’Œé”™è¯¯å¤„ç†"""
              try:
                  # å¢åŠ ç½‘ç»œè¯·æ±‚è¶…æ—¶
                  response = requests.get(url, timeout=10)
                  response.raise_for_status()  # æ£€æµ‹HTTPé”™è¯¯
                  return feedparser.parse(response.content)
              except requests.exceptions.RequestException as e:
                  print(f"âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}")
                  return None
          
          try:
              # è·å–RSSå†…å®¹
              feed = fetch_rss_feed(RSS_URL)
              posts = []
              
              if not feed or feed.get('bozo', 1) == 1:
                  raise Exception("RSSè§£æå¤±è´¥æˆ–è¿”å›ç©ºå†…å®¹")
              
              # è§£ææ–‡ç« åˆ—è¡¨
              for entry in feed.entries[:MAX_POSTS]:
                  # å®‰å…¨è·å–å­—æ®µï¼Œé¿å…KeyError
                  title = entry.get('title', 'No Title').strip() or 'No Title'
                  link = entry.get('link', '#').strip() or '#'
                  published = entry.get('published', '')
                  
                  date_str = ''
                  if published:
                      try:
                          # å…¼å®¹æ›´å¤šæ—¶é—´æ ¼å¼
                          if len(published) >= 10:
                              date_obj = datetime.strptime(published[:10], '%Y-%m-%d')
                              date_str = date_obj.strftime('%Y-%m-%d')
                          else:
                              date_str = published
                      except Exception as e:
                          print(f"âš ï¸ æ—¶é—´æ ¼å¼è§£æå¤±è´¥: {e}ï¼Œä½¿ç”¨åŸå§‹å€¼: {published[:20]}")
                          date_str = published[:20]
                  
                  posts.append({
                      'title': title,
                      'link': link,
                      'date': date_str
                  })
              
              # æ„å»ºæ–‡ç« åˆ—è¡¨æ–‡æœ¬
              if posts:
                  post_lines = []
                  for idx, post in enumerate(posts, 1):
                      date_prefix = f"ğŸ“… {post['date']} " if post['date'] else ""
                      post_lines.append(f"- {date_prefix}[{post['title']}]({post['link']})")
                  posts_text = "\n".join(post_lines)
                  new_section = f"""<!-- BLOG-POST-LIST:START -->
{posts_text}
<!-- BLOG-POST-LIST:END -->"""
              else:
                  new_section = """<!-- BLOG-POST-LIST:START -->
- âŒ æ— æ³•è·å–åšå®¢æ–‡ç«  / Unable to fetch blog posts
<!-- BLOG-POST-LIST:END -->"""
              
              # è¯»å†™READMEæ–‡ä»¶ï¼ˆå¢åŠ å¼‚å¸¸å¤„ç†ï¼‰
              try:
                  with open(README_PATH, 'r', encoding='utf-8') as f:
                      content = f.read()
              except FileNotFoundError:
                  raise Exception(f"âŒ æ‰¾ä¸åˆ°æ–‡ä»¶: {README_PATH}")
              except PermissionError:
                  raise Exception(f"âŒ æ²¡æœ‰æƒé™è¯»å–æ–‡ä»¶: {README_PATH}")
              
              # æ›¿æ¢æ–‡ç« åˆ—è¡¨éƒ¨åˆ†ï¼ˆç¡®ä¿æ­£åˆ™åŒ¹é…æ­£ç¡®ï¼‰
              pattern = r'<!-- BLOG-POST-LIST:START -->.*?<!-- BLOG-POST-LIST:END -->'
              new_content = re.sub(pattern, new_section, content, flags=re.DOTALL)
              
              # å†™å…¥æ–‡ä»¶
              with open(README_PATH, 'w', encoding='utf-8') as f:
                  f.write(new_content)
              
              print(f"âœ… æˆåŠŸæ›´æ–° {len(posts)} ç¯‡åšå®¢æ–‡ç« ")
              
          except Exception as e:
              print(f"âŒ æ‰§è¡Œå‡ºé”™: {str(e)}")
              # å†™å…¥é”™è¯¯æç¤ºåˆ°README
              error_section = """<!-- BLOG-POST-LIST:START -->
- âŒ è·å–åšå®¢æ–‡ç« å¤±è´¥ / Failed to fetch blog posts
<!-- BLOG-POST-LIST:END -->"""
              try:
                  with open(README_PATH, 'r', encoding='utf-8') as f:
                      content = f.read()
                  new_content = re.sub(r'<!-- BLOG-POST-LIST:START -->.*?<!-- BLOG-POST-LIST:END -->', error_section, content, flags=re.DOTALL)
                  with open(README_PATH, 'w', encoding='utf-8') as f:
                      f.write(new_content)
              except:
                  pass
              raise  # æŠ›å‡ºå¼‚å¸¸è®©Actionå¤±è´¥ï¼Œä¾¿äºæ’æŸ¥
          PYEOF

      - name: Commit and push changes
        run: |
          # é…ç½®gitç”¨æˆ·ä¿¡æ¯
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹
          git add README.md
          if git diff --cached --quiet; then
              echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°README.mdçš„ä¿®æ”¹ï¼Œè·³è¿‡æäº¤"
          else
              # ä½¿ç”¨åŒ—äº¬æ—¶é—´ä½œä¸ºcommitä¿¡æ¯
              git commit -m "ğŸ”„ Sync blog posts - $(date '+%Y-%m-%d %H:%M:%S') (CST)"
              # å®‰å…¨pushï¼ˆå¢åŠ é‡è¯•ï¼‰
              git push || (sleep 5 && git push) || (sleep 10 && git push)
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: success()